# docker实战

## 目录

- [图形化管理界面Portainer](#图形化管理界面Portainer)
- [宝塔Linux面板](#宝塔Linux面板)
- [k8s安装部署](#k8s安装部署)
- [docker安装centos7镜像](#docker安装centos7镜像)
- [使用Docker Registry搭建私有镜像仓库](使用Docker&nbsp;Registry搭建私有镜像仓库)
- [docker搭建consul集群](#docker搭建consul集群)
- [.NET Core微服务应用部署](#.NET&nbsp;Core微服务应用部署)

## 图形化管理界面Portainer

```sh
docker pull portainer/portainer
```

## 宝塔Linux面板

官网：[https://www.bt.cn/download/linux.html](https://www.bt.cn/download/linux.html)

安装方法：

- Centos安装脚本：
  
  ```sh
  yum install -y wget && wget -O install.sh http://download.bt.cn/install/install_6.0.sh && sh install.sh
  ```

- Ubuntu/Deepin安装脚本：
  
  ```sh
  wget -O install.sh http://download.bt.cn/install/install-ubuntu_6.0.sh && sudo bash install.sh
  ```

- Debian安装脚本：
  
  ```sh
  wget -O install.sh http://download.bt.cn/install/install-ubuntu_6.0.sh && bash install.sh
  ```

- Fedora安装脚本：
  
  ```sh
  wget -O install.sh http://download.bt.cn/install/install_6.0.sh && bash install.sh
  ```

默认端口：8888

为了提高安全性，当前宝塔新安装的已经开启了安全目录登录，新装机器都会随机一个8位字符的目录名，亦可以在面板设置处修改，如您没记录或不记得了，可以使用以下方式解决：登陆SSH终端输入以下一种命令来解决

1. 查看面板入口：/etc/init.d/bt default
2. 关闭入口验证：rm -f /www/server/panel/data/admin_path.pl

## k8s安装部署

**1、安装kubelet、kubeadm 和 kubectl：**

kubelet 运行在 Cluster 所有节点上，负责启动 Pod 和容器。

kubeadm 用于初始化 Cluster.

添加阿里源，国外的你懂的：

```sh
# vim /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=0
```

安装kubelet kubeadm kubectl：

```sh
yum install -y kubelet kubeadm kubectl
```

启用kubelet：

```sh
systemctl enable kubelet.service
```

关闭swap：

```sh
swapoff -a
```

**2、使用kubeadm创建cluster：**

初始化master：

```sh
kubeadm init --apiserver-advertise-address 192.168.2.120 --pod-network-cidr=10.244.0.0/16
```

参数说明：

- --apiserver-advertise-address

  API服务器将公布它正在监听的IP地址。指定“0.0.0.0”以使用默认网络接口的地址。

- -pod-network-cidr string

  指定pod网络的IP地址范围。如果设置，控制平面将自动为每个节点分配CIDR。

## docker安装centos7镜像

```sh
docker pull centos:7
docker run -it <IMAGE ID> /bin/bash
```

## 使用Docker&nbsp;Registry搭建私有镜像仓库

1、下载镜像registry

```sh
docker pull registry
```

2、运行registry容器

```sh
docker run -itd -v /data/registry:/var/lib/registry -p 5000:5000 --restart=always --name registry registry:latest

# 测试镜像仓库中所有的镜像
curl http://127.0.0.1:5000/v2/_catalog
```

参数说明：

- -itd：在容器中打开一个伪终端进行交互操作，并在后台运行；
- -v：把宿主机的/data/registry目录绑定 到 容器/var/lib/registry目录(这个目录是registry容器中存放镜像文件的目录)，来实现数据的持久化；
- -p：映射端口；访问宿主机的5000端口就访问到registry容器的服务了；
- --restart=always：这是重启的策略，假如这个容器异常退出会自动重启容器；
- --name registry：创建容器命名为registry，你可以随便命名；
registry:latest：这个是刚才pull下来的镜像；

3、为镜像打标签

```sh
docker tag consul:latest 10.30.100.103:5000/consul:v1
```

- consul:lastest 这是源镜像，也是刚才pull下来的镜像文件；
- 10.30.100.103:5000/consul:v1：这是目标镜像，也是registry私有镜像服务器的IP地址和端口；

4、上传到镜像服务器

```sh
docker push 10.30.100.103:5000/consul:v1
```

提示：`Get https://10.30.100.103:5000/v2/: http: server gave HTTP response to HTTPS client`

注意，这是报错了，需要https的方法才能上传，我们可以修改下daemon.json来解决：

```sh
vim /etc/docker/daemon.json
```

```json
{
  "registry-mirrors": ["https://registry.docker-cn.com"],
  "insecure-registries": ["10.30.100.103:5000"]
}
```

添加私有镜像服务器的地址，注意书写格式为json，有严格的书写要求，然后重启docker服务：

```sh
systemctl  restart docker
```

再次上传，没问题。

5、拉取私有镜像

```sh
docker pull 10.30.100.103:5000/consul:v1

# 测试镜像仓库中所有的镜像
curl http://127.0.0.1:5000/v2/_catalog
# 列出consul镜像有哪些tag
curl http://127.0.0.1:5000/v2/consul/tags/list
```

## docker搭建consul集群

1、拉取consul镜像

```sh
docker pull consul
```

2、网络配置（**验证未通过**）

我们准备搭建 3 个 server 节点和 1 个 client 节点，因此我们先需要配置 4 个 docker 容器节点的网络。

因为 docker 默认的 docker0 虚拟网卡是不支持直接设置静态ip的。所以我们先创建一个自己的虚拟网络。

```sh
docker network create --subnet=10.30.100.0/24 staticnet
# 执行完可以通过下面命令查看
docker network
```

>私有网络ip选取小知识：  
>这三个地址段分别位于A、B、C三类地址内：  
>A类地址：10.0.0.0--10.255.255.255  
>B类地址：172.16.0.0--172.31.255.255  
>C类地址：192.168.0.0--192.168.255.255

3、启动 server 节点

我们将要创建的两个 server 节点命名为 s1，s2。

```sh
mkdir -p /opt/config/consul/consul_server_config
```

下面先创建好配置文件，在 /opt/config/consul/consul_server_config 目录添加配置文件 basic_config.json，其中的内容如下：

```sh
vim /opt/config/consul/consul_server_config/basic_config.json
```

```json
{
  "datacenter": "dc1",
  "log_level": "INFO",
  "node_name": "s1", // 指定节点名，同集群内不能重复
  "server": true, // 以server模式运行，不添加默认以client模式运行
  "bootstrap_expect": 2, // 组成集群需要启动的server数量
  "bind_addr": "0.0.0.0",
  "client_addr": "0.0.0.0", // 可以访问的ip
  "ui": true, // 是否启用面板管理
  "ports": {
    "dns": 8600,
    "http": 8500,
    "https": -1,
    "server": 8300,
    "serf_lan": 8301,
    "serf_wan": 8302
  },
  "rejoin_after_leave": true,
  "retry_join": [ // 在意外断开连接后，会不会自动重新加入集群
    "10.30.100.103",
    "10.30.100.104"
  ],
  "retry_interval": "30s",
  "reconnect_timeout": "72h"
}
```

Consul Server是一个有状态的容器，它有两个目录可以挂载本地的目录进去，方便改动配置和数据持久化：

- /consul/config：配置目录，如果agent可以把json配置放这里，会自动加载
- /consul/data：consul数据目录，存放节点、KV、datacenter等数据

为了consul server能稳定提供服务，一般都建议有3-5个consul server组成集群。如果有很多台机器，在启动足够的consul server后，其它主机可以都作为client运行。

启动Consul：

```sh
# --net staticnet选项验证未通过，所以不加
docker run -d \
-p 8500:8500 \
-p 8300-8302:8300-8302 \
-p 8600:8600 \
-v /data/consul_data/data:/consul/data \
-v /data/consul_data/conf:/consul/config \
-v /opt/config/consul/consul_server_config/basic_config.json:/consul/config/basic_config.json \
-h node2 \
--name consul_s2 \
--net staticnet \
--ip 10.30.100.103 \
consul agent \
-server \
-bootstrap-expect=1 \
-node=node2 \
-rejoin \
-client 0.0.0.0 \
-ui \
-data-dir /consul/data \
-config-dir /consul/config
```

使用配置文件的方式暂未成功，使用直接加参数的方式启动集群：

```sh
# 建立数据目录和配置目录
mkdir -p /data/consul_data/data && mkdir -p /data/consul_data/conf

# 试一下这个命令（测试）
docker run -d \
-p 8500:8500 \
-p 8300-8302:8300-8302 \
-p 8600:8600 \
-v /data/consul_data/data:/consul/data \
-v /data/consul_data/conf:/consul/config \
-h node1 \
--name consul  \
--restart=always \
consul agent \
-server \
-bootstrap-expect=1 \
-node=node1 \
-rejoin \
-client 0.0.0.0 \
-ui \
-data-dir /consul/data \
-config-dir /consul/config

# 启动主机1（--net=host先不加入）
docker run -d \
-p 8500:8500 \
-p 8300-8302:8300-8302 \
-p 8600:8600 \
-h node1 \
-v /data/consul_data/data:/consul/data \
-v /data/consul_data/conf:/consul/config \
--net=host \
--restart=always \
--name consul_s1 \
consul agent \
-server \
-rejoin \
-node=node1 \
-bind=10.30.100.104 \
-client 0.0.0.0 \
-ui \
-bootstrap-expect=2 \
-data-dir /consul/data \
-config-dir /consul/config

# 启动主机2
docker run -d \
-p 8500:8500 \
-p 8300-8302:8300-8302 \
-p 8600:8600 \
-h node2 \
-v /data/consul_data/data:/consul/data \
-v /data/consul_data/conf:/consul/config \
--net=host \
--restart=always \
--name consul_s2 \
consul agent \
-server \
-rejoin \
-node=node2 \
-bind=10.30.100.103 \
-client 0.0.0.0 \
-ui \
-bootstrap-expect=2 \
-data-dir /consul/data \
-config-dir /consul/config \
-join 10.30.100.104
```

命令说明：

- --net=host：采用主机网络配置，若采用默认的bridge模式，则会存在容器跨主机间通信失败的问题
- -v /data/consul_data/data:/consul/data：主机的数据目录挂载到容器的/consul/data下，因为该容器默认的数据写入位置即是/consul/data
- -v /data/consul_data/conf:/consul/config：主机的配置目录挂载到容器的/consul/conf下，因为该容器默认的数据写入位置即是/consul/conf
- consul agent -server：consul的server启动模式
- consul agent -bind=10.30.100.103：consul绑定到主机的ip上
- consul agent  -bootstrap-expect=2：server要想启动，需要至少2个server
- consul agent -data-dir /consul/data：consul的数据目录
- consul agent -config-dir /consul/config：consul的配置目录
- consul agent -join 10.30.100.104：对于主机二来说，需要加入到这个集群里

都启动完成后，可以通过如下命令观察consul日志，了解启动情况：

```sh
docker logs 容器id/容器名称
```

查看docker image的构建过程：

```sh
docker history leadgateway --format "table {{.ID}}\t{{.CreatedBy}}" --no-trunc
```

## .NET&nbsp;Core微服务应用部署

网关Dockfile：

```sh
# 拉取 .net core 2.1 镜像
FROM mcr.microsoft.com/dotnet/core/aspnet:2.1-stretch-slim AS base
# 工作目录
WORKDIR /app

COPY . .

# 开放端口
EXPOSE 80
EXPOSE 443

ENTRYPOINT ["dotnet", "LeadChina.Gateway.dll"]
```

```sh
# 启动
docker run -d -p 6080:6080 --name gateway1 --restart=always leadgateway
```

认证服务器Dockfile：

```sh
FROM mcr.microsoft.com/dotnet/core/aspnet:2.1-stretch-slim AS base
WORKDIR /app

COPY . .

EXPOSE 80
EXPOSE 443

ENTRYPOINT ["dotnet", "LeadChina.JwtServer.dll"]
```

```sh
# 启动
docker run -d -p 6181:6181 --name jwtServer --restart=always leadjwt
```

系统设置微服务应用Dockfile：

```sh
FROM mcr.microsoft.com/dotnet/core/aspnet:2.1-stretch-slim AS base
WORKDIR /app

COPY . .

EXPOSE 80
EXPOSE 443

ENTRYPOINT ["dotnet", "LeadChina.PM.SysSetting.API.dll"]
```

```sh
# 启动
docker run -d -p 6082:6082 --name sysSetting --restart=always pm_setting
```
