# 分布式架构

## 目录

1. 理论
   - [分布式系统特性](#分布式系统特性)
   - [分布式系统常见问题](#分布式系统常见问题)
   - [CAP理论简介](#CAP理论简介)

## 理论

关于“分布式系统”的定义，《分布式系统原理和范型》一书中是这样阐述的：**分布式系统是若干独立计算机的集合，这些计算机对于用户来说就像是单个相关系统**。

>分布式系统出现之前，软件系统都是集中式的，俗称单机系统。在很长的一段时期，单机系统通过升级硬件就能满足不断增长的性能需求，然而，随着互联网的飞速发展，高吞吐、高并发、低延迟逐渐成为“刚需”，单凭硬件升级已无能为力，分布式系统 “应需求而生”。

为何分布式系统会被广泛应用呢？原因很简单：**需求驱动**。

>说得直白点，就像开餐厅，每天供应50个人用餐，一个厨师，一个灶台就够了；倘若每天供应5000人用餐，恐怕请一个食神也搞不定吧，怎么办呢？安排100个普通厨师，100个灶台同时开火，将5000人的用餐压力分散到各个厨师，并使用员工守则对厨师进行管理。

通常，只有在单机系统完全无法满足需求的时候，我们才考虑分布式系统。因为，分布式系统提供的服务与单机系统本质是一样的，但分布式系统更为复杂，会引入很多单机系统没有的问题，为了解决这些问题又会引入更多的机制、协议，进而带来更多的问题。鉴于此，<b style="color:red">单机系统能够解决的问题，不要盲目采用分布式系统</b>。这一点很好理解：管理一个厨师很容易，管理100个厨师问题就多了。

## 分布式系统特性

- **内聚性**：内聚性是指每一个节点高度自治
- **透明性**：透明性是指系统对用户来说都是透明的，用户无法感知系统是如何实现的。
- **可扩展性**：通常有两种方式：

  - 其一，优化系统的性能或者升级硬件（Scale Up，即垂直扩展）；
  - 其二，增加计算单元（如服务器等）以扩展系统的规模（Scale Out，即水平扩展）

  究竟选择哪种扩展方式呢？**全盘考虑**。

  理想情形：当任务量增加的时候，系统的处理能力可随之增强（比如增加服务器的数量）；当任务量减少的时候，系统的处理能力可以减弱（比如减少服务器的数量），以避免资源浪费，这就是所谓的**动态伸缩**。

  >显然，垂直扩展并不具备动态伸缩的能力，因此，分布式系统通常采用的是水平扩展方式，不仅可以实现动态伸缩，还可以松耦合、提升系统的容错能力。

- **可用性**：在要求的外部资源得到保证的前提下，系统在规定的条件下和规定的时刻或时间区间内处于可执行规定功能状态的能力。

  公式：`Availability = MTBF / (MTBF + MTTR) * 100%`

  >其中，MTBF（Mean Time Between Failure）是指相邻两次故障之间的平均工作时间，MTTR（Mean Time To Repair）是指系统由故障状态转为工作状态所需修复时间的平均值。通常，用 N 个 9 来表征系统可用性，比如99.9%（3-nines Availability），99.999%（5-nines Availability）。

  ![x](./Resource/可用性.png)

- **可靠性**：在给定的时间间隔和给定条件下，系统能正确执行其功能的概率

  >可靠性的量化指标是周期内系统平均无故障运行时间，可用性的量化指标是周期内系统无故障运行的总时间。

  示例：

  >A 系统每年因故障中断 10 次，每次恢复平均要 30 分钟；B 系统每年因故障中断 2 次，每次需 5 小时恢复。则 A 系统可用性比 B 系统高，但可靠性比 B 系统差。
  >
  >**评价可用性：A > B**
  >
  >A系统 = `(365 * 24 - 10 * 0.5) / 10 / ((365 * 24 - 10 * 0.5) / 10 + 0.5) * 100%` = 99.943%
  >
  >B系统 = `(365 * 24 - 2 * 5) / 2 / ((365 * 24 - 2 * 5) / 2 + 5)*100%` = 99.886%
  >
  >**评价可靠性：A < B**
  >
  >A系统 = `(365 * 24 - 10 * 0.5) / 10` = 875.5
  >
  >B系统 = `(365 * 24 - 2 * 5) / 2` = 4375

- **高性能**：不同的系统对性能的衡量指标不同，最常见的：**高并发**，单位时间内处理的任务越多越好；**低延迟**：每个任务的平均时间越少越好。分布式系统的设计初衷便是<b style="color:green">高性能</b>。

- **一致性**：分布式系统为了提高可用性和可靠性，一般会引入冗余（副本）。为了保证这些节点上的状态一致，分布式系统必须解决一致性问题。

  一致性有很多等级：

  一致性等级越强，对用户越友好，但会制约系统的可用性；  
  一致性等级越低，用户就需要兼容数据不一致的情况，但系统的可用性、并发性会好很多。

## 分布式系统常见问题

1、网络并没有那么可靠

- 消息丢失
- 网络分区：两个机房通信中断问题
- 消息乱序：顺序发送的消息不顺序送达
- 数据错误：丢失1个bit也会造成整个数据包的不可用。校验码机制
- 分布式系统三态：“成功”、“失败”、“超时（未知）”
  
  >如果某个节点向另一个节点发起 RPC 调用，即某个节点 A 向另一个节点 B 发送一个消息，节点 B 根据收到的消息内容完成某些操作，并将操作的结果通过另一个消息返回给节点 A，那么这个 RPC 执行的结果有三种状态：“成功”、“失败”、“超时（未知）”，称之为分布式系统的三态。
  >
  >单节点应用发送消息（发给自己）后的执行结果只存在双态：成功 或 失败。

2、节点故障无法避免：监控节点状态

## CAP理论简介

- 2000年由 Eric Brewer 教授在 PODC 的研讨会上提出猜想，后来 Lynch 等人进行了证明：

  >在分布式环境下设计和部署系统时，有三个核心的系统需求：**Consistency（一致性）**，**Availability（可用性）** 和 **PartitionTolerance（分区容忍性）**，但<b style="color:red">三者无法在分布式系统中同时被满足，并且最多只能满足其中两个</b>

- 分布式系统领域的重要理论之一

### 一致性(Consistency)

如果系统对一个写操作返回成功，那么之后的读请求都必须读到这个新数据；如果返回失败，那么所有读操作都不能读到这个数据

对调用者而言数据具有强一致性（Strong Consistency）（又叫原子性 Atomic、线性一致性 Linearizable Consistency)。

### 可用性(Availability)

用户的每个请求都能接受到一个响应，无论响应是成功或失败，即服务在任何时刻都是可用的。

这就要求系统当中不应该有单点的存在（如果服务是单节点部署，一旦节点宕机，服务便不可用了），通常可用性都是通过冗余的方式来实现的。

### 分区容忍性(PartitionTolerance)

Brewer 的定义："No set of failures less than total network failure is allowed to cause the system to respond incorrectly"，即除了整个网络出现故障外，其它的故障都不能导致整个系统无法正确响应。

>分布式系统中，节点间通过网络进行通信，然而可能因为一些故障，导致有些节点之间不连通，整个网络就分成了几块区域。数据就散布在了这些不连通的区域中，从而形成了分区。
>
>当一个数据项只在一个节点中保存时，如果分区出现，那和该节点不连通的部分将无法访问这个数据（即单点故障问题），这时的分区是无法容忍的。提高分区容忍性的办法就是将一个数据项复制到多个节点上（副本思想），在出现分区后，这一数据项就可能分布到各个区里，容忍性就提高了。
>
>然而，要把数据复制到多个节点，就会带来一致性的问题，就是多个节点上面的数据可能是不一致的。要保证一致，每次写操作都要等待全部节点写成功，而等待期间系统是不可用的，从而带来可用性的问题。总的来说，数据存在的节点越多（副本越多），分区容忍性越高，但同时需要复制、更新的数据就越多，一致性就越难保证。为了保证一致性，更新所有节点数据所需要的时间就越长，可用性就会降低。

### CAP——鱼与熊掌不可兼得

根据 CAP 理论，在分布式系统中，CAP 三者不可能同时被满足，在设计分布式系统时，工程师必须做出取舍，一般认为，CAP 只能选择其二。

## 参考

- [什么是分布式系统，如何学习分布式系统](https://www.cnblogs.com/xybaby/p/7787034.html)
- [浅谈分布式缓存那些事儿](http://os.51cto.com/art/201306/397999.htm)
- [多线程并发常见问题](https://www.cnblogs.com/tonghun/p/7086251.html)
- [分布式缓存那些事儿](https://blog.csdn.net/dinglang_2009/article/details/9071075)
- [并发并行与分布式系统 CAP 理论中的 P 到底是个什么意思？](https://www.zhihu.com/question/54105974/answer/139037688)
- [CAP 理论基础（注解）](https://www.jianshu.com/p/9988aab9bd2e)
- [浅谈分布式缓存那些事儿](https://www.cnblogs.com/softidea/p/5555578.html)
