# 分布式架构

## 目录

1. 理论
   - [分布式系统特性](#分布式系统特性)
   - [分布式系统常见问题](#分布式系统常见问题)
   - [CAP理论简介](#CAP理论简介)

>关于“分布式系统”的定义，《分布式系统原理和范型》一书中是这样阐述的：“**分布式系统是若干独立计算机的集合，这些计算机对于用户来说就像是单个相关系统**”。
>
>分布式系统出现之前，软件系统都是集中式的，俗称单机系统。在很长的一段时期，单机系统通过升级硬件就能满足不断增长的性能需求，然而，随着互联网的飞速发展，高吞吐、高并发、低延迟逐渐成为“刚需”，单凭硬件升级已无能为力，分布式系统 “应需求而生”。
>
>为何分布式系统会被广泛应用呢？原因很简单：**需求驱动**。
>
>说得直白点，就像开餐厅，每天供应50个人用餐，一个厨师，一个灶台就够了；倘若每天供应5000人用餐，恐怕请一个食神也搞不定吧，怎么办呢？安排100个普通厨师，100个灶台同时开火，将5000人的用餐压力分散到各个厨师，并使用员工守则对厨师进行管理。
>
>通常，只有在单机系统完全无法满足需求的时候，我们才考虑分布式系统。因为，分布式系统提供的服务与单机系统本质是一样的，但分布式系统更为复杂，会引入很多单机系统没有的问题，为了解决这些问题又会引入更多的机制、协议，进而带来更多的问题。鉴于此，<b style="color:red">单机系统能够解决的问题，不要盲目采用分布式系统</b>。这一点很好理解：管理一个厨师很容易，管理100个厨师问题就多了。

## 分布式系统特性

### 内聚性

内聚性是指每一个节点高度自治

### 透明性

透明性是指系统对用户来说都是透明的，用户无法感知系统是如何实现的。

### 可扩展性

通常有两种方式：

- 其一，优化系统的性能或者升级硬件(Scale Up，即垂直扩展)；
- 其二，增加计算单元（如服务器等）以扩展系统的规模（Scale Out，即水平扩展）

究竟选择哪种扩展方式呢？**全盘考虑**。

理想情形：当任务量增加的时候，系统的处理能力可随之增强（比如增加服务器的数量）；当任务量减少的时候，系统的处理能力可以减弱（比如减少服务器的数量），以避免资源浪费，这就是所谓的**动态伸缩**。

显然，垂直扩展并不具备动态伸缩的能力，因此，分布式系统通常采用的是水平扩展方式，不仅可以实现动态伸缩，还可以松耦合、提升系统的容错能力。

### 可用性

标准定义：在要求的外部资源得到保证的前提下，系统在规定的条件下和规定的时刻或时间区间内处于可执行规定功能状态的能力。

公式：`Availability = MTBF / (MTBF + MTTR)*100%`

>其中，MTBF（Mean Time Between Failure）是指相邻两次故障之间的平均工作时间，MTTR（Mean Time To Repair）是指系统由故障状态转为工作状态所需修复时间的平均值。通常，用 N 个9来表征系统可用性，比如99.9%（3-nines Availability），99.999%（5-nines Availability）。

![x](./Resource/可用性.png)

### 可靠性

定义：在给定的时间间隔和给定条件下，系统能正确执行其功能的概率

>可靠性的量化指标是周期内系统平均无故障运行时间，可用性的量化指标是周期内系统无故障运行的总时间。

示例：

```txt
A 系统每年因故障中断10次，每次恢复平均要30分钟；B 系统每年因故障中断2次，每次需5小时恢复。则 A 系统可用性比 B 系统高，但可靠性比 B 系统差。

评价可用性：A>B

A 系统=(365*24-10*0.5)/10/((365*24-10*0.5)/10 + 0.5)*100% = 99.943%

B 系统=(365*24-2*5)/2/((365*24-2*5)/2 + 5)*100% = 99.886%

评价可靠性：A < B

A 系统=(365*24-10*0.5)/10 = 875.5

B 系统=(365*24-2*5)/2 = 4375
```

### 高性能

不同的系统对性能的衡量指标不同，最常见的：**高并发**，单位时间内处理的任务越多越好；**低延迟**：每个任务的平均时间越少越好。分布式系统的设计初衷便是<b style="color:green">高性能</b>。

### 一致性

分布式系统为了提高可用性和可靠性，一般会引入冗余（副本）。为了保证这些节点上的状态一致，分布式系统必须解决一致性问题。

一致性有很多等级：

- 一致性等级越强，对用户越友好，但会制约系统的可用性；
- 一致性等级越低，用户就需要兼容数据不一致的情况，但系统的可用性、并发性会好很多。

## 分布式系统常见问题

1. 网络并没有那么可靠
   - 消息丢失
   - 网络分区
   - 消息乱序
   - 数据错误
   - 分布式系统三态：“成功”、“失败”、“超时（未知）”
2. 节点故障无法避免

## CAP理论简介

定义：在分布式环境下设计和部署系统时，有三个核心的系统需求：Consistency（一致性），Availability（可用性）和 PartitionTolerance（分区容忍性），但<b style="color:red">三者无法在分布式系统中同时被满足，并且最多只能满足其中两个</b>

### 一致性（Consistency）

- 如果系统对一个写操作返回成功，那么之后的读请求都必须读到这个新数据；
- 如果返回失败，那么所有读操作都不能读到这个数据

>对调用者而言数据具有强一致性（Strong Consistency）（又叫原子性 Atomic、线性一致性 Linearizable Consistency)。

### 可用性（Availability）
