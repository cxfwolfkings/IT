# 读写分离和主从复制

## 目录

1. 主从复制概念
2. 主从复制配置
   - [MySQL配置](#MySQL配置)
   - [SQLServer配置](#SQLServer配置)
3. 日常维护管理
   - [MySQL管理](#MySQL管理)
4. 主从服务器切换

## 主从复制概念

**MySQL：**

将主数据库的 DDL 和 DML 操作通过二进制日志传到复制服务器（也叫从服务器）上，然后在从服务器上对这些日志重新执行（也叫重做），从而使得从服务器和主服务器的数据保持同步。

MySQL 支持一台主服务器同时向多台从服务器进行复制，从服务器同时也可以作为其它服务器的主服务器，实现链状的复制。

>注意：由于 MySQL 实现的是异步的复制，所以主从服务器之间存在一定的差距，在从服务器上进行的查询操作需要考虑到这些数据的差异，一般只有更新不频繁的数据或者对实时性要求不高的数据可以通过从服务器查询，实时性要求高的数据仍然需要从主数据库获得。

**主从复制的优点主要包括以下3个方面：**

1. 如果主服务器出现问题，可以快速切换到从服务器提供服务
2. 可以在从服务器上执行查询操作，降低主服务器的访问压力
3. 可以在从服务器上执行备份，以避免备份期间影响主服务器的服务

## MySQL配置

- 1、主从服务器上安装相同版本数据库（最好5.6版及以上，支持 GTID 同步复制方式）
- 2、主服务器上，设置一个复制使用的账户，并授予复制的权限。

  ```sql
  CREATE USER 'cxf'@'%' IDENTIFIED WITH mysql_native_password BY '518';
  GRANT REPLICATION SLAVE ON *.* TO 'cxf'@'%';
  flush privileges;
  ```

- 3、修改主数据库配置文件`/etc/my.cnf`（Linux下，如果是windows环境：`%MySQL_Home%/my.ini`），开启binlog，并设置 server-id 的值。修改完后，重启服务

  ```ini
  [mysqld]
  # 主从复制配置
  log-bin=D:\Arms\mysql-log\mysql-master.log
  server-id=1
  ```

- 4、在主服务器上，设置读锁定有效，这个操作是为了确保没有数据库操作，以便获得一个一致性的快照：

  ```sql
  flush tables with read lock;
  ```

- 5、然后得到主服务器上当前的二进制日志名和偏移量值(Position)。这个操作的目的是为了在从数据库启动以后，从这个点开始进行数据的恢复

  ```sql
  show master status;
  ```

  ![x](./Resource/mysql_copy1.png)

- 6、现在主数据库服务器已经停止了更新操作，需要生成主数据库的备份，备份的方式有很多种，可以直接在操作系统下 `cp` 全部的数据文件到从数据库服务器上，也可以通过 `mysqldump` 导出数据或者使用 `ibbackup` 工具进行数据库的备份。如果主数据库的服务可以停止，那么直接 `cp` 数据文件应该是最快的生成快照的方法：

- 7、主数据库的备份完毕后，主数据库可以恢复写操作，剩下的操作只需要在从服务器上执行：

  ```sql
  unlock tables;
  ```

- 8、将主数据库的一致性备份恢复到从数据库上。

- 9、修改从数据库的配置文件`my.cnf`，增加 `server-id` 参数。注意 `server-id` 的值必须是唯一的，不能和主数据库的配置相同，如果有多个从数据库服务器，每个从数据库服务器必须有自己唯一的 `server-id` 值。如果只是单向主从，则从库只设置 `server-id` 即可，双向主从则还需要配置 `log-bin`

  ```cnf
  [mysqld]
  server-id = 2
  ```

  >注意：如果是直接复制的库，则还要修改 `server_uuid`。mysql 5.6 开始引入了 uuid 的概念，各个复制结构中的 `server_uuid` 得保证不一样，但是直接复制 data 文件夹后 `server_uuid` 是相同的（`show variables like '%server_uuid%';`）。解决方法：找到 data 文件夹下的 auto.cnf 文件，修改里面的 uuid 值，保证各个 db 的 uuid 不一样，重启 db 即可。

- 10、在从服务器上，使用 `--skip-slave-start` 选项启动从数据库，这样不会立即启动从数据库服务上的复制进程，方便我们对从数据库的服务进行进一步的配置：

  ```sh
  mysqld_safe --skip-slave-start &
  ```

- 11、对从数据库服务器做相应设置，指定复制使用的用户，主数据库服务器的IP、端口以及开始执行复制的日志文件和位置等，具体语法如下：

  ```sql
  change master to
  -> master_host='localhost',
  -> master_port=3306,
  -> master_user='cxf',
  -> master_password='518',
  -> master_log_file='mysql-master.000001',
  -> master_log_pos=155;
  ```

- 12、在从服务器上，启动 slave 线程：

  ```sql
  start slave;
  ```

- 13、这时 slave 上执行 `show processlist` 命令将显示日志进程。这表明 slave 已经连接上 master，并开始接受井执行日志。

  ```sql
  -- 查看从库状态
  show slave status;
  --output：下面两项yes代表设置成功
  slave_IO_Running:yes
  slave_SQL_Running:yes
  ```

- 14、也可以测试复制服务的正确性，在主数据库上执行一个更新操作，观察是否在从数据库上同步。

**主要复制启动选项：**

- master_host
- master_port
- master_user
- master_password
- master_log_file
- master_log_pos
- log-slave-updates：配置从服务器上的更新操作是否写二进制日志，默认是关闭的。但是，如果这个从服务器同时也要作为其它服务器的主服务器，搭建一个链式的复制，那么就需要打开这个选项，这样它的从服务器将获得它的二进制日志以进行同步操作。这个启动参数需要和 `--logs-bin` 参数一起使用。
- master-connect-retry：用来设置在和主服务器的连接丢失的时候，重试的时间间隔，默认是60秒，即每60秒重试一次
- read-only：用来设置从服务器只能接受 `超级用户` 的更新操作，从而限制应用程序错误的对从服务器的更新操作。
- replicate-do-db：指定从主数据库复制到从数据库的数据库
- replicate-do-table：指定从主数据库复制到从数据库的数据表
- replicate-ignore-db
- replicate-ignore-table
- replicate-wild-do-table

## SQLServer配置

## 日常管理维护

### MySQL管理

```sql
-- 从库上执行
show slave status;
```

在显示的信息中，我们主要关心 `"Slave_IO_Running"` 和 `"Slave_SQL_Running"` 这两个进程状态是否是"yes"，这两个进程的含义分别如下：

- Slave_IO_Running：此进程负责从服务器(Slave)从主服务器(Master)上读取 `BINLOG` 日志，并写入从服务器上的中继日志中。
- Slave_SQL_Running：此进程负责读取并且执行中继日志中的 `BINLOG` 日志。

只要其中有一个进程的状态是"no"，则表示复制进程停止，错误原因可以从带 `"Last_Errno"` 和 `"Last_Error"` 字样的列值中看到。
