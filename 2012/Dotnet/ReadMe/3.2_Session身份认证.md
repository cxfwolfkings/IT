# Session身份认证

## Cookie和Session简介

一、关于Cookie和Session此处简单介绍一下、作为初学者可以先了解以下两点

1. Cookie是存于客户端的（即用户电脑）、Session是存于服务端的。
2. Cookie数据所有的浏览器端共享、Session数据由服务器开辟内存保存、每一个浏览器都有一个唯一的SessionID

二、首先需要介绍一下 `FormsAuthentication` 密封类。

1. 用户登录成功后、需要保存用户信息到Cookie（本地）。
   
   可以调用如下方法、下次调用就会判断是否有Cookie信息，如果Cookie信息没有过期可以直接跳过登录。

   该类有一个方法 `SetAuthCookie(string userName, bool createPersistentCookie)`

   >注意：该方法如果被调用多次、则保存最后一个设置的Cookie

   ```C#
   public ActionResult AdminLogin(SysAdmin objAdmin)
   {
    string adminName = new BLL.SysAdminManager().AdminLogin(objAdmin);
    if (adminName != null)
    {
        FormsAuthentication.SetAuthCookie(adminName, true);
        TempData["adminName"] = adminName;
        return RedirectToAction("GetAllStuList", "Student");
    }
    else
    {
        ViewBag.Info = "用户或密码错误";
    }
    return View("AdminLogin");
   }
   ```

2. 判断用户是否通过身份验证并且获取用户名称、没有通过验证、则转到登录页面；已经通过验证、则不需要登录

   ```C#
   public ActionResult Index()
   {

    if (this.User.Identity.IsAuthenticated)
    {
        string adminName = this.User.Identity.Name;// 获取写入的adminName
        ViewBag.adminName = adminName;
        return View("StudentManage");
    }
    else
    {
        return RedirectToAction("Index", "SysAdmin");
    }
   }
   ```

3. 控制器或控制器方法如果添加了 `Authorize` 特性、则通过路由访问之前需要验证是否已经通过身份验证、作用类似于第二点if判断体。

   ```C#
   [Authorize]
   public ActionResult Index()
   {
    string adminName = this.User.Identity.Name; //获取写入的adminName
    ViewBag.adminName = adminName;
    return View("StudentManage");
   }
   ```

   如果浏览器没有登录成功、那么url访问该路由就会失败。如果想要浏览器访问url失败后跳转到指定的页面、可以在Web.config的 `<system.web>` 节点中添加如下标签

   ```xml
   <authentication mode="Forms">
    <forms loginUrl="~/SysAdmin/Index" timeout="2880" />
   </authentication>
   ```

## 扩展：ASP.NET页面之间传递值的方式

1. 使用QueryString（get传值）

   将客户端重定向到新的页面，只是简单地终止当前页面，并转入新的页面开始执行，对转入的页面无任何限制。数据直接在url中传递，可见，但可以加密，简单方便，不可传递大量数据，并不可传递对象

   传值: `Response.Redirect("B.aspx?id="+x);`  
   接受: `textBox1.Text=Request.QueryString["id"].ToString();`

2. 使用Session变量（会话）

   Session对象为当前用户会话提供信息。全局变量，在整个应用程序都可以使用，会话关闭，Session失效。存储在服务器中，依靠cookie来运行，SessionID存放在cookie中。

   由于Web应用程序对每个用户都会生成Session变量，因此它会随着用户数量的增多而加重服务器的负担。如果数据量比较小，Session对象是保存只需要在当前对话中保持的特定数据的极好位置。

   ```C#
   Session["id"]=x;
   textBox1.Text=Session["id"].ToString();
   Session.Remove("id"); //清除Session变量
   ```

3. 使用Server.Transfer（post传值）form

   Src.aspx: 
   
   ```C#
   public string id { get { return TextBox1.Text; } } //定义公共属性
   Server.Transfer("Dst.aspx"); //重定向到目标页面
   ```
   
   Dst.aspx: //HTML中引入PreviousPageType指令

   ```aspx
   <%@ PreviousPageType VirtualPath="~/Src.aspx"%>
   ```
   
   ```C#
   //代码中获取Form数据
   Label1.Text=PreviousPage.id;
   Lable1.Text=Convert.ToString(Request.Form["txtusername"]);
   ```

   终止当前页的执行，并为当前请求开始执行新的页面。把执行流程从当前页面转到同一服务器中的另一页面，但是新的页面仍然使用当前页面创建的应答流。

4. ViewState

   保存原来页面中服务器控件视图状态的数据供新页面使用，存储在客户端，ViewState的工作原理是：作为一个隐藏的窗体字段在客户端和服务器之间传递

   ```C#
   ViewState["id"]=TextBox1.Text; //数据存储
   Label1.Text= ViewState["id"].ToString(); //数据取出
   ViewState.Remove("id"); //数据移除
   ```

5. Cache的使用

   需要设置缓存项优先级和缓存时间。

   Src.aspx: 
   
   ```C#
   Cache["id"]=TextBox1.Text;
   //---------------------------------------
   Cache.Insert("id", x);
   Response.Redirect("Dst.aspx");
   ```

   Dst.aspx: 
   
   ```C#
   if(Cache["id"]!=null) Labell.Text=Cache["id"].ToString();
   Cache.Remove("id"); //移除缓存项
   ```

   如果Cache["id"]为空，则传值失败。
