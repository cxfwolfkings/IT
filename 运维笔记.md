# 运维笔记



## 目录

1. 简介
   - [日志管理](#日志管理)
2. 实战
   - [office online Server2016](#office online Server2016)
3. 总结
4. 升华



## 日志管理

**为什么要进行日志收集？**

应用程序跑在集群中，产生很多的日志，日志中包含着程序运行的情况的纪录，查看单个机器的日志过程繁琐，所以需要统一的日志管理平台对日志进行统一处理，将所有应用程序的日志收集起来，可以对日志进行存储、归档、查询、状态判断。

例如负载均衡的情况，nginx 下面很多的 web 服务，如果查看日志的话需要进入多个 tomcat 一个一个看麻烦吧。

1. ELK 技术解决方案把 tomcat 收集起来

2. Graylog + mongo + elasticsearch 日志收集机器。

**搭建日志系统**

安装要求：docker、docker-compose

配置文件：docker-compose.yml

```dockerfile
some-mongo:
  image: "mongo:3"
  volumes:
    - /opt/graylog/data/mongo:/data/db

some-elasticsearch:
  image: "elasticsearch:latest"
  command: "elasticsearch  -Des.cluster.name='graylog'"
  volumes:
    - /opt/graylog/data/elasticsearch:/usr/share/elasticsearch/data

graylog:
  image: graylog2/server
  volumes:
    - /opt/graylog/data/journal:/usr/share/graylog/data/journal
    - /opt/graylog/config:/usr/share/graylog/data/config

environment:
  GRAYLOG_PASSWORD_SECRET:somepasswordpepper
  GRAYLOG_ROOT_PASSWORD_SHA2:8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918
  GRAYLOG_REST_TRANSPORT_URI: http://192.168.30.3:12900

links:
  - some-mongo:mongo
  - some-elasticsearch:elasticsearch

ports:
  - "9000:9000"
  - "12900:12900"
  - "12201:12201/udp"
  - "1514:1514/udp"
```

直接下载官方推荐配置文件

```sh
wget https://raw.githubusercontent.com/Graylog2/graylog2-images/2.1/docker/config/graylog.conf
```

日志配置文件

```sh
wget https://raw.githubusercontent.com/Graylog2/graylog2-images/2.1/docker/config/log4j2.xml
```

graylog.conf

修改下载完的 graylog.conf 中的 root_timezone 为：

root_timezone =+08:00

**启动运行：**

```sh
docker-compose up
```

**配置graylog：**

```conf
页面：http://192.168.30.3:9000
用户名：admin
密 码：admin
配置Input
```

**启动应用程序容器：**

```sh
docker run -d –name logtest –log-driver=gelf –log-opt gelf-address=udp://192.168.30.3:12201 ubuntu /bin/bash -c "while true;do echo hello;sleep 1;done"
```



## office online Server2016

概述：https://docs.microsoft.com/zh-cn/officeonlineserver/office-online-server

参考：https://www.cnblogs.com/lhxsoft/p/12071215.html

准备：两台主机

1. WOPI Server：域控的主机
2. WOPI Client： 安装office online的主机

支持的操作系统：

- 64 位版本的 Windows Server 2012 R2
- 64 位版本的 Windows Server 2016（要求 Office Online Server 2017 年 4 月或更高版本）

注意事项：

- **请勿在运行 Office Online Server** 的服务器上安装任何其他服务器应用程序。包括 Exchange Server、SharePoint Server、Skype for Business Server 和 SQL Server。如果服务器不足，则可以在这些服务器的其中一台的虚拟机上运行 Office Online Server。

- **不要在端口 80、443 或 809 上安装依赖 Web 服务器 (IIS) 角色的任何服务或角色**，因为 Office Online Server 会定期删除这些端口上的 Web 应用程序。

- **不要安装任何版本的 Office**。如果已经安装，在安装 Office Online Server 之前必须将其卸载。

- **不要在域控制器上安装 Office Online Server**。它不会在包含 Active Directory 域服务 (AD DS) 的服务器上运行

安装步骤：

1. 配置域控服务器【域控主机】

   - 添加角色和功能：Active Directory域服务

   - 安装过程中选择：将此服务器提升为域控制器 -> 添加新林 -> 输入根域名如oos.com -> 输入密码 -> 安装，自动重启

     administrator 设置密码：

     ```bash
     net user administrator "Abc123"
     net user administrator /passwordreq:yes
     ```

2. Office Online Server安装角色和服务【OfficeOnline主机】

   - 管理员身份打开Microsoft PowerShell

   - 2012 R2

     ```bash
     Add-WindowsFeature Web-Server,Web-Mgmt-Tools,Web-Mgmt-Console,Web-WebServer,Web-Common-Http,Web-Default-Doc,Web-Static-Content,Web-Performance,Web-Stat-Compression,Web-Dyn-Compression,Web-Security,Web-Filtering,Web-Windows-Auth,Web-App-Dev,Web-Net-Ext45,Web-Asp-Net45,Web-ISAPI-Ext,Web-ISAPI-Filter,Web-Includes,InkandHandwritingServices,NET-Framework-Features,NET-Framework-Core,NET-HTTP-Activation,NET-Non-HTTP-Activ,NET-WCF-HTTP-Activation45,Windows-Identity-Foundation,Server-Media-Foundation
     ```

   - 2016

     ```bash
     Add-WindowsFeature Web-Server,Web-Mgmt-Tools,Web-Mgmt-Console,Web-WebServer,Web-Common-Http,Web-Default-Doc,Web-Static-Content,Web-Performance,Web-Stat-Compression,Web-Dyn-Compression,Web-Security,Web-Filtering,Web-Windows-Auth,Web-App-Dev,Web-Net-Ext45,Web-Asp-Net45,Web-ISAPI-Ext,Web-ISAPI-Filter,Web-Includes,NET-Framework-Features,NET-Framework-45-Features,NET-Framework-Core,NET-Framework-45-Core,NET-HTTP-Activation,NET-Non-HTTP-Activ,NET-WCF-HTTP-Activation45,Windows-Identity-Foundation,Server-Media-Foundation
     ```

   - Office Online Server安装所需依赖以下软件包：

     [*.NET Framework 4.5.2*](https://go.microsoft.com/fwlink/p/?LinkId=510096)

     [*Visual C++ Redistributable Packages for Visual Studio 2013*](https://www.microsoft.com/download/details.aspx?id=40784)

     [*Visual C++ Redistributable for Visual Studio 2015*](https://go.microsoft.com/fwlink/p/?LinkId=620071)

     [*Microsoft.IdentityModel.Extention.dll*](https://go.microsoft.com/fwlink/p/?LinkId=620072) - MicrosoftIdentityExtensions-64.msi

     Office Online Server程序

     Office Online Server语言包

     执行上面操作后依次安装Office Online Server程序与语言包

3. 域控服务器关联配置【OfficeOnline主机设置加入域】

   - 在OfficeOnline主机中打开网络属性，找到ipv4的配置，配置DNS为"域控制器的IP"

   - 把OfficeOnline服务器加入到域服务器的域中。打开计算机属性，选择隶属于"域"，设置域就是之前安装域控制主机的时候设置的，这里直接填入，继续弹出输入账号密码，这里输入域控制器的用户名和密码即可

   - 在域控服务器把OfficeOnline主机添加进管理中：打开域控服务器 -> 服务器管理器 -> 管理 -> 添加服务器 -> 立即查找 -> 选中OfficeOnline主机添加 -> 点击左侧的所有服务器,显示联机即可

   - 部署使用 HTTP 的单服务器Office Online Server Farm

     > 如果 Microsoft PowerShell 在您运行时无法识别 New-OfficeWebAppsFarm cmdlet，您可能需要导入 OfficeWebApps 模块。请使用此命令：`Import-Module -Name OfficeWebApps`

     1. 创建 Office Online Server 场

        ```bash
        New-OfficeWebAppsFarm -InternalURL "http://WIN-EMU743VLII3.yazid.com/" –ExternalUrl "http://172.16.159.135/" -AllowHttp:true−EditingEnabled:true -ClipartEnabled:$true
        
        Set-OfficeWebAppsFarm –ExternalUrl "http://172.16.159.135/" -AllowHttp:true−EditingEnabled:true -ClipartEnabled:$true
        ```

        参数

        - InternalURL 是运行 Office Online Server 的服务器名称，例如 http://servername。

        - AllowHttp 配置要使用 HTTP 的场。

        - EditingEnabled 在 Office Online 中启用编辑（如果它与 SharePoint Server 2016 一起使用）。Skype for Business Server 2015 或 Exchange Server 不使用此参数，因为这些主机不支持编辑。

        - Get-OfficeWebAppsFarm 返回当前服务器所属的 OfficeWebAppsFarm 对象的详细信息

        - New-OfficeWebAppsFarm 在本地计算机上创建新 Office Online Server 场

        - Set-OfficeWebAppsFarm 配置现有 Office Online Server 场的设置

        - Remove-OfficeWebAppsMachine 从 Office Online Server 场中删除现有服务器(删除Farm)

        **注意**：在执行创建服务场时可能出现提示用户名或者密码不正确，这时需要把两台服务器密码改成相同，并且重启之后即可

     2. 验证是否成功创建 Office Online Server 场

        在创建服务器场后，将在 Microsoft PowerShell 提示符中显示有关服务器场的详细信息。若要验证是否正确安装并配置了 Office Online Server，请使用 Web 浏览器访问 Office Online Server 发现 URL是您在配置 Office Online Server 服务器场时指定的 InternalUrl 参数，后跟 /hosting/discovery，例如：http://servername/hosting/discovery，如果 Office Online Server 按预期运行，您应该在 Web 浏览器中看到 Web 应用程序开放平台接口 (WOPI) 协议发现 XML 文件。

     3. 配置 Secure Store 访问（可选）

        如果计划使用 HTTP 环境中 SharePoint 服务器的 Secure Store Service，则需要设置可启用此服务的参数。（如果未计划将 SharePoint 服务器中的 Secure Store 与 Excel Online 一起使用，则可跳过此步骤）

        当 Office Online Server 试图刷新工作簿或存储在 HTTP 路径中的 ODC 文件的数据时，如果尚未配置 Office Online Server 以允许通过 HTTP 的 Secure Store 连接，则数据刷新将失败。

        使用 Set-OfficeWebAppsFarm cmdlet 配置通过 HTTP 的 Secure Store 设置：

        Set-OfficeWebAppsFarm -AllowHttpSecureStoreConnections:$true

        请记住将通过 HTTP 以明文形式传送工作簿的内容或 ODC 文件。数据连接工作簿和 ODC 文件包含数据库连接信息，并可以包含密码。

     4. 配置主机

        服务器场现在已经可以通过 HTTP 为主机提供 Office Online 功能。有关如何配置主机的详细信息，请查阅以下文章。

        配置 SharePoint Server 2016 的 Office Online Server

        Office Online Server integration with Exchange（Office Online Server 与 Exchange 的集成）

   - 部署Wopi项目

     使用说明：https://www.netnr.com/doc/code/4964095842855914510

     wopi相关文档：https://wopi.readthedocs.io/en/latest/

     可以参照以下wopi代码：

     https://github.com/netnr/WopiHost

     https://github.com/marx-yu/WopiHost

     https://github.com/OfficeDev/PnP-WOPI

     https://github.com/thebitllc/WopiBasicEditor

     https://code.msdn.microsoft.com/office/Building-an-Office-Web-f98650d6

     https://github.com/Microsoft/Office-Online-Test-Tools-and-Documentation

     https://github.com/oec2003/OWAEditorSample.git

